<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mode Exercise Game</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000000" />

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  height: 100%;
  overflow: hidden;
}

#exerciseVideo {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  background: black;
}

video::-webkit-media-controls {
  display: none !important;
}

#overlay {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  pointer-events: none;
}

button {
  pointer-events: auto;
  padding: 18px 28px;
  font-size: 1.2rem;
  font-weight: bold;
  border-radius: 14px;
  border: none;
  background: #2563eb;
  color: white;
}

button:disabled {
  background: #334155;
}

/* ===== BEAT PULSE BASE ===== */
#beatPulse {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) scale(1);
  border-radius: 50%;
  opacity: 0;
  z-index: 15;
  pointer-events: none;
}

/* ===== MODE STYLES (INTENSITY SCALED) ===== */
.pulse-slow {
  background: #22c55e;
  width: 10px;
  height: 10px;
  --pulse-scale: 1.4;
  --pulse-opacity: 0.5;
}

.pulse-medium {
  background: #facc15;
  width: 14px;
  height: 14px;
  --pulse-scale: 1.7;
  --pulse-opacity: 0.65;
}

.pulse-fast {
  background: #fb923c;
  width: 17px;
  height: 17px;
  --pulse-scale: 2.0;
  --pulse-opacity: 0.8;
}

.pulse-veryfast {
  background: #ef4444;
  width: 22px;
  height: 22px;
  --pulse-scale: 2.4;
  --pulse-opacity: 0.95;
}

/* ===== ANIMATION ===== */
.pulse {
  animation: pulse 140ms ease-out;
}

@keyframes pulse {
  0% {
    opacity: var(--pulse-opacity);
    transform: translateX(-50%) scale(1);
    box-shadow: 0 0 0 rgba(255,255,255,0.3);
  }
  100% {
    opacity: 0;
    transform: translateX(-50%) scale(var(--pulse-scale));
    box-shadow: 0 0 18px rgba(255,255,255,0);
  }
}
</style>
</head>

<body>

<video
  id="exerciseVideo"
  playsinline
  webkit-playsinline
  muted
  preload="auto"
></video>

<audio
  src="background.mp3"
  controls
  loop
  style="position:fixed;bottom:10px;right:10px;width:140px;opacity:0.6;z-index:20"
></audio>

<div id="overlay">
  <button id="start">Start</button>
</div>

<div id="beatPulse"></div>

<script>
/* ================= CONFIG ================= */
const PREP_TIME = 10000;
const MODE_TIME = [5000, 35000];
const EX_TIME = [30000, 90000];

const MODES = ["Stop", "Slow", "Medium", "Fast", "Very Fast"];

const BPM = {
  Slow: 60,
  Medium: 100,
  Fast: 140,
  "Very Fast": 170
};

const VIBRATION = {
  Slow: 80,
  Medium: 120,
  Fast: 180,
  "Very Fast": 260
};

const EXERCISES = Array.from({ length: 15 }, (_, i) => `Exercise ${i + 1}`);
const EXERCISE_VIDEOS = Object.fromEntries(
  EXERCISES.map((e, i) => [e, `${i + 1}.mp4`])
);

/* ================= RNG ================= */
function createRng(seed) {
  return function () {
    seed |= 0;
    seed = seed + 0x6D2B79F5 | 0;
    let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
    t ^= t + Math.imul(t ^ t >>> 7, 61 | t);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

const rng = createRng(
  crypto.getRandomValues(new Uint32Array(1))[0] ^ Date.now()
);

/* ================= STATE ================= */
const state = {
  exerciseDeck: [],
  modeDeck: [],
  timers: {}
};

/* ================= ELEMENTS ================= */
const videoEl = document.getElementById("exerciseVideo");
const startBtn = document.getElementById("start");
const beatPulse = document.getElementById("beatPulse");

/* ================= AUDIO ================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let metronomeInterval = null;

function speak(text) {
  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

function vibrateForMode(mode) {
  navigator.vibrate?.(VIBRATION[mode] || 0);
}

/* ===== VISUAL PULSE ===== */
function setPulseStyle(mode) {
  beatPulse.className = "";
  if (mode === "Slow") beatPulse.classList.add("pulse-slow");
  else if (mode === "Medium") beatPulse.classList.add("pulse-medium");
  else if (mode === "Fast") beatPulse.classList.add("pulse-fast");
  else if (mode === "Very Fast") beatPulse.classList.add("pulse-veryfast");
}

function triggerPulse() {
  beatPulse.classList.remove("pulse");
  void beatPulse.offsetWidth;
  beatPulse.classList.add("pulse");
}

/* ===== METRONOME ===== */
function startMetronome(bpm) {
  clearInterval(metronomeInterval);
  if (!bpm) return;

  const interval = 60000 / bpm;
  metronomeInterval = setInterval(() => {
    const osc = audioCtx.createOscillator();
    osc.frequency.value = 1000;
    osc.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.05);
    triggerPulse();
  }, interval);
}

/* ================= HELPERS ================= */
const rand = (min, max) =>
  Math.floor(rng() * (max - min + 1)) + min;

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function rotate(deck) {
  const n = Math.floor(rng() * deck.length);
  return deck.slice(n).concat(deck.slice(0, n));
}

/* ================= EXERCISE ================= */
function nextExercise() {
  if (!state.exerciseDeck.length) {
    state.exerciseDeck = rotate(shuffle([...EXERCISES]));
  }
  return state.exerciseDeck.shift();
}

/* ================= MODE ================= */
function nextMode() {
  if (!state.modeDeck.length) {
    state.modeDeck = rotate(shuffle([...MODES]));
  }
  return state.modeDeck.shift();
}

/* ================= VIDEO ================= */
function playExerciseVideo(exercise) {
  const src = EXERCISE_VIDEOS[exercise];
  if (!src) return;
  videoEl.pause();
  videoEl.loop = true;
  videoEl.src = src;
  videoEl.load();
  videoEl.play().catch(() => {});
}

/* ================= FULLSCREEN ================= */
function requestFullscreen() {
  const el = document.documentElement;
  el.requestFullscreen?.() ||
  el.webkitRequestFullscreen?.() ||
  el.msRequestFullscreen?.();
}

/* ================= GAME FLOW ================= */
function startPrep() {
  startBtn.disabled = true;
  startBtn.style.display = "none";

  const firstExercise = nextExercise();
  playExerciseVideo(firstExercise);

  const start = Date.now();
  let spoken = null;

  state.timers.prep = setInterval(() => {
    const remaining = Math.ceil(
      (PREP_TIME - (Date.now() - start)) / 1000
    );

    if ([3,2,1].includes(remaining) && remaining !== spoken) {
      speak(remaining);
      spoken = remaining;
    }

    if (remaining <= 0) {
      clearInterval(state.timers.prep);
      speak("Go");
      startGame(firstExercise);
    }
  }, 200);
}

function startGame(exercise) {
  scheduleExercise(exercise);
  changeMode();
}

function scheduleExercise(current) {
  state.timers.exercise = setTimeout(() => {
    const next = nextExercise();
    playExerciseVideo(next);
    scheduleExercise(next);
  }, rand(...EX_TIME));
}

function changeMode() {
  const mode = nextMode();
  speak(mode);
  vibrateForMode(mode);
  setPulseStyle(mode);
  startMetronome(BPM[mode]);
  state.timers.mode = setTimeout(changeMode, rand(...MODE_TIME));
}

/* ================= EVENTS ================= */
startBtn.addEventListener("click", async () => {
  requestFullscreen();
  await audioCtx.resume();
  videoEl.play().catch(() => {});
  startPrep();
});

/* ================= SERVICE WORKER ================= */
navigator.serviceWorker?.register("sw.js");
</script>

</body>
</html>
