<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mode Exercise Game</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000000" />

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  height: 100%;
  overflow: hidden;
}

#exerciseVideo {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  background: black;
}

video::-webkit-media-controls {
  display: none !important;
}

#overlay {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  pointer-events: none;
}

button {
  pointer-events: auto;
  padding: 18px 28px;
  font-size: 1.2rem;
  font-weight: bold;
  border-radius: 14px;
  border: none;
  background: #2563eb;
  color: white;
}

button:disabled {
  background: #334155;
}
</style>
</head>

<body>

<video
  id="exerciseVideo"
  playsinline
  webkit-playsinline
  muted
  preload="auto"
></video>

<audio
  src="background.mp3"
  controls
  loop
  style="position:fixed;bottom:10px;right:10px;width:140px;opacity:0.6;z-index:20"
></audio>

<div id="overlay">
  <button id="start">Start</button>
</div>

<script>
/* ================= CONFIG ================= */
const PREP_TIME = 10000;
const MODE_TIME = [5000, 35000];
const EX_TIME = [30000, 90000];

const MODES = ["Stop", "Slow", "Medium", "Fast"];
const BPM = { Slow: 60, Medium: 100, Fast: 140 };

const EXERCISES = Array.from({ length: 15 }, (_, i) => `Exercise ${i + 1}`);
const EXERCISE_VIDEOS = Object.fromEntries(
  EXERCISES.map((e, i) => [e, `${i + 1}.mp4`])
);

/* ================= STRONG SESSION RNG ================= */
// Mulberry32 PRNG
function createRng(seed) {
  return function () {
    seed |= 0;
    seed = seed + 0x6D2B79F5 | 0;
    let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
    t ^= t + Math.imul(t ^ t >>> 7, 61 | t);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

// High-entropy session seed
const SESSION_SEED =
  crypto.getRandomValues(new Uint32Array(1))[0] ^ Date.now();

const rng = createRng(SESSION_SEED);

/* ================= STATE ================= */
const state = {
  exerciseDeck: [],
  modeDeck: [],
  lastExercise: null,
  lastMode: null,
  timers: {}
};

/* ================= ELEMENTS ================= */
const videoEl = document.getElementById("exerciseVideo");
const startBtn = document.getElementById("start");

/* ================= AUDIO ================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let metronomeInterval = null;

function speak(text) {
  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

function vibrate(ms = 200) {
  navigator.vibrate?.(ms);
}

function startMetronome(bpm) {
  clearInterval(metronomeInterval);
  if (!bpm) return;

  const interval = 60000 / bpm;
  metronomeInterval = setInterval(() => {
    const osc = audioCtx.createOscillator();
    osc.frequency.value = 1000;
    osc.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.05);
  }, interval);
}

/* ================= HELPERS ================= */
const rand = (min, max) =>
  Math.floor(rng() * (max - min + 1)) + min;

function shuffleSeeded(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function rotateDeck(deck) {
  const n = Math.floor(rng() * deck.length);
  return deck.slice(n).concat(deck.slice(0, n));
}

/* ================= EXERCISE SELECTION ================= */
function nextExercise() {
  if (!state.exerciseDeck.length) {
    state.exerciseDeck = rotateDeck(
      shuffleSeeded([...EXERCISES]) || [...EXERCISES]
    );

    if (state.exerciseDeck[0] === state.lastExercise) {
      [state.exerciseDeck[0], state.exerciseDeck[1]] =
      [state.exerciseDeck[1], state.exerciseDeck[0]];
    }
  }

  state.lastExercise = state.exerciseDeck.shift();
  return state.lastExercise;
}

/* ================= MODE SELECTION ================= */
function nextMode() {
  if (!state.modeDeck.length) {
    state.modeDeck = rotateDeck(
      shuffleSeeded([...MODES]) || [...MODES]
    );

    if (state.modeDeck[0] === state.lastMode) {
      [state.modeDeck[0], state.modeDeck[1]] =
      [state.modeDeck[1], state.modeDeck[0]];
    }
  }

  state.lastMode = state.modeDeck.shift();
  return state.lastMode;
}

/* ================= VIDEO ================= */
function playExerciseVideo(exercise) {
  const src = EXERCISE_VIDEOS[exercise];
  if (!src) return;

  videoEl.pause();
  videoEl.loop = true;
  videoEl.src = src;
  videoEl.load();
  videoEl.play().catch(() => {});
}

/* ================= GAME FLOW ================= */
function startPrep() {
  startBtn.disabled = true;
  startBtn.style.display = "none";

  const firstExercise = nextExercise();
  playExerciseVideo(firstExercise);

  const start = Date.now();
  let spoken = null;

  state.timers.prep = setInterval(() => {
    const remaining = Math.ceil(
      (PREP_TIME - (Date.now() - start)) / 1000
    );

    if ([3, 2, 1].includes(remaining) && remaining !== spoken) {
      speak(remaining);
      spoken = remaining;
    }

    if (remaining <= 0) {
      clearInterval(state.timers.prep);
      speak("Go");
      startGame(firstExercise);
    }
  }, 200);
}

function startGame(exercise) {
  scheduleExercise(exercise);
  changeMode();
}

function scheduleExercise(current) {
  state.timers.exercise = setTimeout(() => {
    const next = nextExercise();
    playExerciseVideo(next);
    scheduleExercise(next);
  }, rand(...EX_TIME));
}

function changeMode() {
  const mode = nextMode();
  speak(mode);
  vibrate();
  startMetronome(BPM[mode]);

  state.timers.mode = setTimeout(changeMode, rand(...MODE_TIME));
}

/* ================= EVENTS ================= */
startBtn.addEventListener("click", async () => {
  await audioCtx.resume();
  videoEl.play().catch(() => {});
  startPrep();
});

/* ================= SERVICE WORKER ================= */
navigator.serviceWorker?.register("sw.js");
</script>

</body>
</html>
