<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mode Exercise Game</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000000" />

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  height: 100%;
  overflow: hidden;
}

#exerciseVideo {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  background: black;
}

video::-webkit-media-controls {
  display: none !important;
}

#overlay {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  pointer-events: none;
}

button {
  pointer-events: auto;
  padding: 18px 28px;
  font-size: 1.2rem;
  font-weight: bold;
  border-radius: 14px;
  border: none;
  background: #2563eb;
  color: white;
}

button:disabled {
  background: #334155;
}

/* ===== BEAT PULSE (CENTERED) ===== */
#beatPulse {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(1);
  border-radius: 50%;
  opacity: 1;
  z-index: 15;
  pointer-events: none;
}

/* ===== 1.8x BOOSTED MODES ===== */
.pulse-slow {
  background: #22c55e;
  width: 36px;
  height: 36px;
  --pulse-scale: 2.6;
  --pulse-opacity: 1;
}

.pulse-medium {
  background: #facc15;
  width: 50px;
  height: 50px;
  --pulse-scale: 3.2;
  --pulse-opacity: 1;
}

.pulse-fast {
  background: #fb923c;
  width: 62px;
  height: 62px;
  --pulse-scale: 3.8;
  --pulse-opacity: 1;
}

.pulse-veryfast {
  background: #ef4444;
  width: 80px;
  height: 80px;
  --pulse-scale: 4.6;
  --pulse-opacity: 1;
}

/* ===== STRONG, CLEAR PULSE ===== */
.pulse {
  animation: pulse 420ms cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes pulse {
  0% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    box-shadow: 0 0 0 rgba(255,255,255,0.5);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(var(--pulse-scale));
    box-shadow: 0 0 60px rgba(255,255,255,0);
  }
}
</style>
</head>

<body>

<video id="exerciseVideo" playsinline webkit-playsinline muted preload="auto"></video>

<audio
  src="background.mp3"
  controls
  loop
  style="position:fixed;bottom:10px;right:10px;width:140px;opacity:0.6;z-index:20">
</audio>

<div id="overlay">
  <button id="start">Start</button>
</div>

<div id="beatPulse"></div>

<script>
/* ================= CONFIG ================= */
const MODE_TIME = [5000, 35000];
const EX_TIME = [30000, 90000];

const MODES = ["Stop", "Slow", "Medium", "Fast", "Very Fast"];

const BPM = {
  Slow: 60,
  Medium: 100,
  Fast: 140,
  "Very Fast": 170
};

const VIBRATION = {
  Slow: 280,
  Medium: 430,
  Fast: 650,
  "Very Fast": 900
};

const EXERCISES = Array.from({ length: 15 }, (_, i) => `Exercise ${i + 1}`);
const EXERCISE_VIDEOS = Object.fromEntries(
  EXERCISES.map((e, i) => [e, `${i + 1}.mp4`])
);

/* ================= RNG ================= */
function createRng(seed) {
  return function () {
    seed |= 0;
    seed = seed + 0x6D2B79F5 | 0;
    let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
    t ^= t + Math.imul(t ^ t >>> 7, 61 | t);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}
const rng = createRng(
  crypto.getRandomValues(new Uint32Array(1))[0] ^ Date.now()
);

/* ================= STATE ================= */
const state = { exerciseDeck: [], modeDeck: [], timers: {} };

/* ================= ELEMENTS ================= */
const videoEl = document.getElementById("exerciseVideo");
const startBtn = document.getElementById("start");
const beatPulse = document.getElementById("beatPulse");

/* ================= AUDIO ================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let metronomeInterval = null;

function speak(text) {
  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

function vibrateForMode(mode) {
  navigator.vibrate?.(VIBRATION[mode] || 0);
}

/* ===== VISUAL PULSE ===== */
function setPulseStyle(mode) {
  beatPulse.className = "";
  if (mode === "Slow") beatPulse.classList.add("pulse-slow");
  else if (mode === "Medium") beatPulse.classList.add("pulse-medium");
  else if (mode === "Fast") beatPulse.classList.add("pulse-fast");
  else if (mode === "Very Fast") beatPulse.classList.add("pulse-veryfast");
}

function triggerPulse() {
  beatPulse.classList.remove("pulse");
  void beatPulse.offsetWidth;
  beatPulse.classList.add("pulse");
}

/* ===== METRONOME ===== */
function startMetronome(bpm) {
  clearInterval(metronomeInterval);
  if (!bpm) return;

  const interval = 60000 / bpm;
  metronomeInterval = setInterval(() => {
    const osc = audioCtx.createOscillator();
    osc.frequency.value = 1000;
    osc.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.05);
    triggerPulse();
  }, interval);
}

/* ================= HELPERS ================= */
const rand = (min, max) =>
  Math.floor(rng() * (max - min + 1)) + min;

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function rotate(deck) {
  const n = Math.floor(rng() * deck.length);
  return deck.slice(n).concat(deck.slice(0, n));
}

/* ================= FLOW ================= */
function nextExercise() {
  if (!state.exerciseDeck.length)
    state.exerciseDeck = rotate(shuffle([...EXERCISES]));
  return state.exerciseDeck.shift();
}

function nextMode() {
  if (!state.modeDeck.length)
    state.modeDeck = rotate(shuffle([...MODES]));
  return state.modeDeck.shift();
}

function playExerciseVideo(ex) {
  videoEl.pause();
  videoEl.loop = true;
  videoEl.src = EXERCISE_VIDEOS[ex];
  videoEl.load();
  videoEl.play().catch(() => {});
}

function requestFullscreen() {
  document.documentElement.requestFullscreen?.();
}

/* ================= GAME ================= */
function startGame() {
  const first = nextExercise();
  playExerciseVideo(first);
  scheduleExercise(first);
  changeMode();
}

function scheduleExercise(ex) {
  state.timers.exercise = setTimeout(() => {
    const next = nextExercise();
    playExerciseVideo(next);
    scheduleExercise(next);
  }, rand(...EX_TIME));
}

function changeMode() {
  const mode = nextMode();
  speak(mode);
  vibrateForMode(mode);
  setPulseStyle(mode);
  startMetronome(BPM[mode]);
  state.timers.mode = setTimeout(changeMode, rand(...MODE_TIME));
}

/* ================= EVENTS ================= */
startBtn.addEventListener("click", async () => {
  startBtn.style.display = "none";
  requestFullscreen();
  await audioCtx.resume();
  videoEl.play().catch(() => {});
  startGame(); /* immediate start, no prep delay */
});

navigator.serviceWorker?.register("sw.js");
</script>
</body>
</html>
